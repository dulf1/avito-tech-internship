# **Тестовое задание для стажёра Backend (осенняя волна 2025)**

## **Сервис назначения ревьюеров для Pull Request’ов**

Внутри команды требуется единый микросервис, который автоматически назначает ревьюеров на Pull Request’ы (PR), а также позволяет управлять командами и участниками. Взаимодействие происходит исключительно через HTTP API.

## **Описание задачи**

Необходимо реализовать сервис, который назначает ревьюеров на PR из команды автора, позволяет выполнять переназначение ревьюверов и получать список PR’ов, назначенных конкретному пользователю, а также управлять командами и активностью пользователей. После merge PR изменение состава ревьюверов запрещено.

## **Общие вводные**

**Пользователь (User)** - участник команды с уникальным идентификатором, именем и флагом активности `isActive`.

**Команда (Team)** - группа пользователей с уникальным именем.

**Pull Request (PR)** - сущность с идентификатором, названием, автором, статусом `OPEN|MERGED`и списком назначенных ревьюверов (до 2).

1. При создании PR автоматически назначаются **до двух** активных ревьюверов из **команды автора**, исключая самого автора.
2. Переназначение заменяет одного ревьювера на случайного **активного** участника **из команды заменяемого** ревьювера.
3. После `MERGED` менять список ревьюверов **нельзя**.
4. Если доступных кандидатов меньше двух, назначается доступное количество (0/1).

## Архитектура

- `internal/domain`
    - `errors.go`, `events.go`, `unit_of_work.go`, `random.go` - доменные абстракции и ошибки.
    - `team/` - сущность `Team`, `Member`, `Repository`, `Service`.
    - `user/` - сущность `User`, `Repository`, `Service` (SetUserActive).
    - `pr/` - сущности `PullRequest`, `PullRequestShort`, статусы, репозиторий и сервис (Create, Merge, Reassign, GetUserReviews).

- `internal/infrastructure`
    - `db/pg` - Postgres (pgx `database/sql`), `TxManager` (UnitOfWork), репозитории `team`, `user`, `pr`.
    - `async` - `WorkerPool` и `AsyncEventBus` для асинхронной обработки доменных событий.
    - `logging` - zap-логгер.

- `internal/app`
    - `config` - конфиг (env: `DATABASE_URL`, `HTTP_ADDR`).
    - `dto` - DTO для HTTP API.
    - `http` - gin-роутер, middleware, HTTP-обработчики.

- `cmd/app`
    - точка входа: DI, миграции (goose), запуск HTTP-сервера.

## Запуск

### Через docker-compose

```bash
# Собрать и запустить все сервисы
docker-compose up --build

# В фоновом режиме
docker-compose up -d --build

# Остановить сервисы
docker-compose down

# Остановить и удалить volumes (очистить БД)
docker-compose down -v
```

Сервис будет доступен на `http://localhost:8080` (или порт из `APP_PORT`).
- PostgreSQL 16 на порту из `POSTGRES_PORT` (по умолчанию `5432`)
- Приложение на порту из `APP_PORT` (по умолчанию `8080`)
- Автоматически применяются миграции при старте приложения

## Основные эндпоинты
* `POST /team/add` - создать команду и пользователей.
* `GET /team/get?team_name=...` - получить команду с участниками.
* `POST /users/setIsActive` - включить/выключить пользователя.
* `GET /users/getReview?user_id=...` - получить список PR, где пользователь - ревьювер.
* `POST /pullRequest/create` - создать PR и автоматически назначить до двух ревьюверов.
* `POST /pullRequest/merge` - пометить PR как merged (идемпотентно).
* `POST /pullRequest/reassign` - переназначить ревьювера.
* `GET /stats/assignments` - статистика назначений (параметры: `scope=all|users|prs`, `team_name=...`).

## Доменные правила
* Ревьюверы выбираются случайно из активных участников команды автора, автор не может быть ревьювером.
* При reassign:
    * нельзя переназначать PR в статусе `MERGED`;
    * выбирается активный участник команды, не автор и не уже назначенный ревьювер;
    * если кандидатов нет, возвращается ошибка `NO_CANDIDATE` (409).

* Merge - идемпотентный: повторный вызов возвращает актуальное состояние.

## Тестирование

### Интеграционные тесты

Интеграционные тесты находятся в `tests/integration_test.go` и проверяют работу всего приложения через HTTP API.

**Требования:**
- Запущенная PostgreSQL база данных (можно через `docker-compose up db`)
- Переменные окружения для подключения к БД (или используются значения по умолчанию)

**Запуск тестов:**

```bash
# Запустить все интеграционные тесты
go test ./tests

# С подробным выводом
go test  -v ./tests

# Запустить конкретный тест
go test -v ./tests -run TestIntegration_CreateTeamAndPRFlow

# Запустить все тесты с покрытием
go test -v -cover ./tests
```

**Настройка подключения к БД:**

По умолчанию тесты используют те же параметры, что и docker-compose:
- `POSTGRES_HOST=localhost` (или `TEST_DATABASE_URL` для полного DSN)
- `POSTGRES_USER=pruser`
- `POSTGRES_PASSWORD=prpass`
- `POSTGRES_PORT=5432`
- `POSTGRES_DB=prdb`

**Что проверяют тесты:**
- `TestIntegration_CreateTeamAndPRFlow` - создание команды и PR с автоматическим назначением ревьюверов
- `TestIntegration_MergeIsIdempotent` - идемпотентность операции merge
- `TestIntegration_ReassignReviewer` - переназначение ревьювера
- `TestIntegration_UserGetReview` - получение списка PR для ревьювера

**Примечание:** Тесты автоматически применяют миграции и очищают БД между запусками.

### Unit тесты

Unit тесты для доменных сервисов находятся рядом с кодом в `internal/domain/*/service_test.go`.

```bash
# Запустить все unit тесты
go test ./internal/domain/...

# Запустить тесты конкретного сервиса
go test ./internal/domain/team
go test ./internal/domain/user
go test ./internal/domain/pr
go test ./internal/domain/stats
```
